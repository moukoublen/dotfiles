#!/usr/bin/env bash

set -e

# global path: /usr/local/lib/docker/cli-plugins
PLUGINS_DIR="${HOME}/.docker/cli-plugins/"
mkdir -p "${PLUGINS_DIR}"

__remote_version() {
  local JS_BODY="${1}"
  echo "${JS_BODY}" | jq -r '.name'
}
export -f __remote_version

__local_version() {
  local BIN_DIR="${1:-/usr/local/bin}"
  [[ -f "${BIN_DIR}/docker-compose" ]] && "${BIN_DIR}/docker-compose" version | awk '{ print $4 }'
}
export -f __local_version

__get_dl_url() {
  local JS_BODY="${1}"
  local BINARY="docker-compose-linux-x86_64"
  if [[ $(uname) = "Darwin" ]]; then
    BINARY="docker-compose-darwin-x86_64"
  fi
  echo "${JS_BODY}" | jq -r ".assets[] | select(.name | test(\"^${BINARY}$\")) | .browser_download_url"
}
export -f __get_dl_url

__install_exec() {
  local BIN_DIR="${1}"
  local DOWNLOADED_FULL_PATH="${2}"
  local TMP_DIR="$(dirname "${DOWNLOADED_FULL_PATH}")"
  cp "${DOWNLOADED_FULL_PATH}" "${BIN_DIR}"/docker-compose
  chmod +x "${BIN_DIR}"/docker-compose
}
export -f __install_exec


install-from-github \
  --name                 "docker-compose" \
  --repo                 "docker/compose" \
  --fn-remote-version    "__remote_version" \
  --fn-local-version     "__local_version" \
  --fn-get-download-link "__get_dl_url" \
  --download-to-file     "docker-compose-linux-x86_64" \
  --fn-install           "__install_exec" \
  --destination          "${PLUGINS_DIR}" \
  "${@}"

